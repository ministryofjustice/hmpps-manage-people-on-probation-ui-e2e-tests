name: Playwright Tests
on:
  # Run manually via GitHub API
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    # Every weekday at 09:00 UTC
  schedule:
    - cron: "0 9 * * MON-FRI"
jobs:
  test:
    timeout-minutes: 60
    runs-on: moj-cloud-platform
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Clean npm cache
      run: npm cache clean --force
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install
    - name: Run Playwright tests
      id: tests
      run: npx bddgen && npx playwright test -g "@smoke"  --workers=4 --retries=1
      env:
        TZ: Europe/London
        ENV: test

        # URLs
        DELIUS_URL: https://ndelius.test.probation.service.justice.gov.uk
        MANAGE_PEOPLE_ON_PROBATION_URL: https://manage-people-on-probation-dev.hmpps.service.justice.gov.uk
        MAS_API_URL: https://manage-supervision-and-delius-dev.hmpps.service.justice.gov.uk
        E_SUPERVISION_API_URL: https://esupervision-api-dev.hmpps.service.justice.gov.uk
        SIGN_IN_URL: https://sign-in-dev.hmpps.service.justice.gov.uk
        OUTLOOK_API_URL: https://probation-supervision-appointments-api-dev.hmpps.service.justice.gov.uk

        # Credentials
        DELIUS_USERNAME: ${{ secrets.E2E_DELIUS_USERNAME }}
        DELIUS_PASSWORD: ${{ secrets.E2E_DELIUS_PASSWORD }}
        API_USERNAME: ${{ secrets.API_USERNAME }}
        API_PASSWORD: ${{ secrets.API_PASSWORD }}


    - name: Publish JUnit report
      if: always()
      uses: mikepenz/action-junit-report@cf701569b05ccdd861a76b8607a66d76f6fd4857 # v5.5.1
      id: junit
      with:
        check_name: End-to-end test results
        report_paths: junit.xml

    - name: Create sanitised Playwright stats summary (overall + per file)
      if: always() && github.ref == 'refs/heads/main'
      id: stats
      run: |
        node <<'EOF'
        const fs = require('fs');
        
        const reportPath = 'results.json';
        if (!fs.existsSync(reportPath)) {
          console.error(`Missing ${reportPath}. Ensure playwright.config.ts has ['json', { outputFile: 'results.json' }].`);
          process.exit(0);
        }
        
        const input = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
        const s = input.stats || {};
        
        function formatDuration(ms) {
          const totalSeconds = Math.floor((ms || 0) / 1000);
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
        
          if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
          if (minutes > 0) return `${minutes}m ${seconds}s`;
          return `${seconds}s`;
        }
        
        // ---- Per-file aggregation ----
        const perFile = new Map(); // file -> { passed, failed, skipped, flaky, durationMs }
        
        function ensure(file) {
          const key = file || 'unknown';
          if (!perFile.has(key)) perFile.set(key, { passed: 0, failed: 0, skipped: 0, flaky: 0, durationMs: 0 });
          return perFile.get(key);
        }
        
        function walkSuite(suite, inheritedFile) {
          const file = suite.file || inheritedFile;
        
          for (const spec of (suite.specs || [])) {
            const specFile = spec.file || file || 'unknown';
        
            for (const t of (spec.tests || [])) {
              for (const r of (t.results || [])) {
                const f = ensure(specFile);
                f.durationMs += (r.duration || 0);
        
                if (r.status === 'passed') f.passed++;
                else if (r.status === 'skipped') f.skipped++;
                else if (r.status === 'flaky') f.flaky++;
                else f.failed++; // failed / timedOut / interrupted etc.
              }
            }
          }
        
          for (const child of (suite.suites || [])) walkSuite(child, file);
        }
        
        for (const top of (input.suites || [])) walkSuite(top, top.file);
        
        const perFileArray = [...perFile.entries()]
          .map(([file, v]) => ({ file, ...v, duration: formatDuration(v.durationMs) }))
          .sort((a, b) => (b.failed - a.failed) || (b.passed - a.passed) || a.file.localeCompare(b.file));
        
        // ALL files (no truncation)
        const perFileLines = perFileArray.map(x =>
          `• ${x.file}: ✅ ${x.passed} ❌ ${x.failed} ⏭️ ${x.skipped} ⏱️ ${x.duration}`
        ).join('\n') || '• (No test files found)';
        
        const summary = {
          stats: {
            startTime: s.startTime,
            duration: formatDuration(s.duration),
            expected: s.expected || 0,
            skipped: s.skipped || 0,
            unexpected: s.unexpected || 0,
            flaky: s.flaky || 0
          },
          perFile: perFileArray
        };
        
        fs.writeFileSync('stats-summary.json', JSON.stringify(summary, null, 2));
        
        // ---- Outputs ----
        const out = process.env.GITHUB_OUTPUT;
        fs.appendFileSync(out, `duration=${summary.stats.duration}\n`);
        fs.appendFileSync(out, `expected=${summary.stats.expected}\n`);
        fs.appendFileSync(out, `unexpected=${summary.stats.unexpected}\n`);
        fs.appendFileSync(out, `flaky=${summary.stats.flaky}\n`);
        fs.appendFileSync(out, `skipped=${summary.stats.skipped}\n`);
        fs.appendFileSync(out, `per_file<<PERFILE\n${perFileLines}\nPERFILE\n`);
        
        // Slack-friendly multiline (avoid JSON/YAML escaping issues in the Slack step)
        const slackText =
          `• Duration: ${summary.stats.duration}\n` +
          `• Passed: ${summary.stats.expected}\n` +
          `• Failed: ${summary.stats.unexpected}\n` +
          `• Flaky: ${summary.stats.flaky}\n` +
          `• Skipped: ${summary.stats.skipped}\n\n` +
          `*Per file:*\n${perFileLines}`;
        
        fs.appendFileSync(out, `slack_text<<SLACK\n${slackText}\nSLACK\n`);
        EOF

        

    - name: Upload stats summary
      if: always() && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
         name: playwright-stats
         path: stats-summary.json
         retention-days: 7

    - name: Notify Slack
      if: always() && github.ref == 'refs/heads/main'
      uses: slackapi/slack-github-action@v2.1.1
      with:
        method: chat.postMessage
        token: ${{ secrets.HMPPS_SLACK_BOT_TOKEN }}
        payload: |
          {
            "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
            "text": "*Playwright E2E:* `${{ job.status }}` — `${{ github.repository }}` on `${{ github.ref_name }}`\n${{ steps.stats.outputs.slack_text }}\n\n• Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
