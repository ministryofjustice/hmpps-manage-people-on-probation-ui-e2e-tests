name: Playwright Tests
on:
  # Run manually via GitHub API
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    # Every weekday at 08:00 UTC
  schedule:
    - cron: "0 8 * * MON-FRI"
jobs:
  test:
    timeout-minutes: 60
    runs-on: moj-cloud-platform
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Clean npm cache
      run: npm cache clean --force
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install
    - name: Run Playwright tests
      id: tests
      run: npx playwright test -g "Alerts page" --reporter=html,junit,json,line --workers=1 --retries=0
      env:
        TZ: Europe/London
        ENV: test
        TEST_DIR: ${{ inputs.directory || 'tests' }}
        PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit.xml
        PLAYWRIGHT_JSON_OUTPUT_NAME: results.json

        # URLs
        DELIUS_URL: https://ndelius.test.probation.service.justice.gov.uk
        MANAGE_PEOPLE_ON_PROBATION_URL: https://manage-people-on-probation-dev.hmpps.service.justice.gov.uk

        # Credentials
        DELIUS_USERNAME: ${{ secrets.E2E_DELIUS_USERNAME }}
        DELIUS_PASSWORD: ${{ secrets.E2E_DELIUS_PASSWORD }}

    - name: Publish JUnit report
      if: always()
      uses: mikepenz/action-junit-report@cf701569b05ccdd861a76b8607a66d76f6fd4857 # v5.5.1
      id: junit
      with:
        check_name: End-to-end test results
        report_paths: junit.xml

    - name: Create sanitised Playwright stats summary
      id: stats
      run: |
            node <<'EOF'
            const fs = require('fs');
            
            const input = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            const s = input.stats || {};
            
            function formatDuration(ms) {
              const totalSeconds = Math.floor((ms || 0) / 1000);
              const hours = Math.floor(totalSeconds / 3600);
              const minutes = Math.floor((totalSeconds % 3600) / 60);
              const seconds = totalSeconds % 60;
            
              if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
              if (minutes > 0) return `${minutes}m ${seconds}s`;
              return `${seconds}s`;
            }
            
            const summary = {
              stats: {
                startTime: s.startTime,
                duration: formatDuration(s.duration),
                expected: s.expected || 0,
                skipped: s.skipped || 0,
                unexpected: s.unexpected || 0,
                flaky: s.flaky || 0
              }
            };
            
            fs.writeFileSync(
              'stats-summary.json',
              JSON.stringify(summary, null, 2)
            );
            
            const out = process.env.GITHUB_OUTPUT;
            fs.appendFileSync(out, `duration=${summary.stats.duration}\n`);
            fs.appendFileSync(out, `expected=${summary.stats.expected}\n`);
            fs.appendFileSync(out, `unexpected=${summary.stats.unexpected}\n`);
            fs.appendFileSync(out, `flaky=${summary.stats.flaky}\n`);
            fs.appendFileSync(out, `skipped=${summary.stats.skipped}\n`);
            EOF
        

    - name: Upload stats summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
         name: playwright-stats
         path: stats-summary.json
         retention-days: 7

    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v2.1.1
      with:
         method: chat.postMessage
         token: ${{ secrets.HMPPS_SLACK_BOT_TOKEN }}
         payload: |
               channel: ${{ secrets.SLACK_CHANNEL_ID }}
               text: >
                 *Playwright E2E:* `${{ job.status }}` — `${{ github.repository }}` on `${{ github.ref_name }}`
                 • Duration: ${{ steps.stats.outputs.duration }}
                 • Passed: ${{ steps.stats.outputs.expected }}
                 • Failed: ${{ steps.stats.outputs.unexpected }}
                 • Flaky: ${{ steps.stats.outputs.flaky }}
                 • Skipped: ${{ steps.stats.outputs.skipped }}
                 • Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}         
